#!/bin/bash
# /usr/local/apps/Connect/AppRun
# Wifi Connect/disconnect interface from network_tray
# Argument 1: connect, disconnect

if [ -z `which gsu` ]; then
[ "`whoami`" != "root" ] && exec gksu ${0} "$@"
else
[ "`whoami`" != "root" ] && exec gsu ${0} "$@"
fi

. /lib/libtaz.sh
export TEXTDOMAIN='slitaz-boxes' #i18n
RUNMODE="$1"

# fredx181 function Yad colored-splash
set_gtkrc()
{
# Yad colored-splash
# Set variables for foreground, background, fontname and text.
[ -z "$FOREGROUND" ] && FOREGROUND="#000000"
[ -z "$BACKGROUND" ] && BACKGROUND="#7FD785"
[ -z "$FONTNAME" ] && FONTNAME="Bold 10"
cat > /tmp/gtkrc.yad <<EOF
style "default" { bg[NORMAL] = "$BACKGROUND" fg[NORMAL] = "$FOREGROUND" font_name="$FONTNAME" } class "GtkWidget"    style "default"
EOF
}
export -f set_gtkrc

start_wifi() {
. /etc/network.conf
# If no ESSID saved, run wifi-box and exit
if [ -z "$WIFI_ESSID" ]; then
	sed -i \
		-e s'/^DHCP=.*/DHCP="yes"/' \
		-e s'/^STATIC=.*/STATIC="no"/' \
		-e s'/^WIFI=.*/WIFI="yes"/' \
		/etc/network.conf
	ifconfig $WIFI_INTERFACE up
	iwconfig $WIFI_INTERFACE txpower auto
wifi-box &
fi
ret=$!
[ "$ret" ] && exit 
# fredx181 change, splash message
set_gtkrc
GTK2_RC_FILES="/tmp/gtkrc.yad" yad --on-top --title=apt2sfs --text="    Disconnecting wired network...   \n Trying to connect to Wifi network \n \t    Please wait... " --center --undecorated --no-buttons --timeout 6 &

	sed -i \
		-e s'/^DHCP=.*/DHCP="yes"/' \
		-e s'/^STATIC=.*/STATIC="no"/' \
		-e s'/^WIFI=.*/WIFI="yes"/' \
		/etc/network.conf
	ifconfig $WIFI_INTERFACE up
	iwconfig $WIFI_INTERFACE txpower auto
	/etc/init.d/network.sh start
}
export -f start_wifi
 
# fredx181 change, function connect_wired, to switch to wired connection (if available) when stopping Wifi
connect_wired() {
set_gtkrc
GTK2_RC_FILES="/tmp/gtkrc.yad" yad --on-top --title=apt2sfs --text="  \tDisconnecting Wifi... \n Trying to connect to wired network   \n \t    Please wait... " --center --undecorated --no-buttons --timeout 6 &
. /etc/network.conf
sed -i -e s'/^WIFI=.*/WIFI="no"/' /etc/network.conf
ifconfig $INTERFACE up && sleep 5
# fredx181 change, instead /etc/udhcpc/default.script read from custom script (for splash messages)
rm -f /tmp/no_fail_message    # created from /etc/slitaz/wifibox_udhcpc script
rm -f /tmp/no_connect_message   # created from /etc/slitaz/wifibox_udhcpc script
	[ -f /var/run/udhcpc.$INTERFACE.pid ] && killall udhcpc
# fredx181 change, instead /etc/udhcpc/default.script read from custom script (for splash message)
/sbin/udhcpc -b -T 1 -A 12 -i $INTERFACE -p /var/run/udhcpc.$INTERFACE.pid -s /etc/slitaz/wifibox_udhcpc

}
export -f connect_wired
 
case $RUNMODE in
  --connect)
   /bin/bash -c start_wifi
   ;;
  --disconnect)
   /etc/init.d/network.sh stop; sleep 3; /bin/bash -c connect_wired
   ;;
esac


###END###
